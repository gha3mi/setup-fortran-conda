name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash -el {0}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        compiler: [gfortran, ifx, lfortran, flang-new]
        exclude:
          - os: macos-latest
            compiler: flang-new
          - os: macos-latest
            compiler: ifx
          - os: windows-latest
            compiler: lfortran

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Conda
        uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: fortran
          channels: conda-forge, defaults

      - name: Install setup-fortran-conda dependencies
        run: npm install
        working-directory: ./.github/actions/setup-fortran-conda

      - name: Setup Fortran Conda environment
        uses: ./.github/actions/setup-fortran-conda
        with:
          compiler: ${{ matrix.compiler }}
          platform: ${{ matrix.os }}

      - name: Verify installations
        run: |
          fpm --version
          # ${{ matrix.compiler }} --version

      - name: fpm test (debug)
        run: fpm test --compiler ${{ matrix.compiler }} --profile debug

      - name: fpm test (release)
        run: fpm test --compiler ${{ matrix.compiler }} --profile release